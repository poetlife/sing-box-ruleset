name: release-singbox-rule

on:
    push:
        branches: ["main"]
    pull_request:
        branches: [main]

jobs:
    build:
        runs-on: ubuntu-latest

        steps: 
            - name: checkout
              uses: actions/checkout@v4
            
            - name: setup-python
              uses: actions/setup-python@v3
              with:
                python-version: "3.10"

            - name: install-py-dependencies
              run: |
                python -m pip install --upgrade pip
                if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

            - name: convert-yaml2json
              run: |
                python convert.py

            - name: setup-sing-box
              run: |
                bash <(curl -fsSL https://sing-box.app/deb-install.sh)

            - name: compile-rulesets
              run: |
                for file in "sources/*"; do if [ -f "$file" ]; then sing-box rule-set compile "$file" fi done

            - name: release
              uses: softprops/action-gh-release@v1
              if: startsWith(github.ref, 'refs/tags/')
              with:
                files: ./output/*
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
